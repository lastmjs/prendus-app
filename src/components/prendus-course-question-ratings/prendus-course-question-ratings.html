<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../node_modules/redux-store-element/redux-store.html">
<link rel="import" href="../prendus-ui/prendus-styles.html">
<link rel="import" href="../prendus-stacked-bar/prendus-stacked-bar.html">
<link rel="import" href="../prendus-flaggable-question/prendus-flaggable-question.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<dom-module id="prendus-course-question-ratings">

  <template>

    <style include="prendus-styles">
      h2 {
        margin-bottom: 20px;
      }

      #questions {
        margin-top: 10px;
        border-bottom: 1px solid;
      }

      #table-header {
        background: var(--prendus-primary-color);
        color: white;
        border-radius: 15px 15px 0 0;
        border: none;
        align-items: center;
      }

      #table-header .table-cell {
        border: none;
        font-size: 14px;
      }

      .sortable {
        cursor: pointer;
      }

      .sortable:hover, .sortable:focus {
        text-decoration: underline;
      }

      .question-row {
        display: grid;
        grid-auto-rows: 4vw;
        grid-template-columns: 5fr; /* 3fr;*/
        grid-auto-columns: 1fr;
        grid-auto-flow: column;
        border-left: 1px solid;
      }

      .question-row .table-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5%;
        border-right: 1px solid;
        border-bottom: 1px solid;
        overflow: hidden;
      }

      .question-meta {
        justify-content: normal !important;
      }

      .scroll {
        overflow-x: auto !important;
      }

      #question-modal {
        position: fixed;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
      }

      .question-text {
        position: relative;
      }

      .question-text .view-question-link {
        position: absolute;
        bottom: 5px;
        right: 5px;
        cursor: pointer;
      }

      [hidden] {
        display: none;
      }

    </style>
    <redux-store id="reduxStoreElement" action="[[action]]" on-statechange="stateChange"></redux-store>

    <div>
      <h2 id="question-rating-table-header">Questions: [[course.title]]</h2>
      <label for="assignmentId">Assignment</label>
      <select id="assignmentId" on-change="_assignmentIdChanged">
        <option value="ALL">All</option>
        <!-- TODO For some reason the <dom-repeat> element does not play nice inside select boxes -->
        <template is="dom-repeat" items="[[_assignments(questionStats)]]">
          <option value="[[item.id]]">[[item.title]]</option>
        </template>
      </select>
      <label for="conceptId">Concept</label>
      <select id="conceptId" on-change="_conceptIdChanged">
        <option value="ALL">All</option>
          <template is="dom-repeat" items="[[_concepts(questionStats)]]">
            <option value="[[item.id]]">[[item.title]]</option>
          </template>
      </select>
      <div id="questions" role="grid" aria-readonly="true" aria-labelledby="question-rating-table-header">
        <div id="table-header" class="question-row" role="row">
          <div class="table-cell column-header question-meta" scope="col" role="columnheader" aria-sort="none">Question</div>
          <div id="Student" class="table-cell column-header" scope="col" role="columnheader" aria-sort$="[[_ariaSort('Student', sortField, sortAsc)]]"><span class="sortable" on-click="_toggleSort" on-keydown="_checkToggleSort" role="button" tabindex="0">Student</span></div>
          <dom-repeat items="[[categories]]" hidden>
            <template>
              <div class="column-header table-cell" scope="col" role="columnheader" aria-sort$="[[_ariaSort(item, sortField, sortAsc)]]"><span class="sortable" on-click="_toggleSort" role="button" on-keydown="_checkToggleSort" tabindex="0">[[item]]</span></div>
            </template>
          </dom-repeat>
          <div id="Overall" class="table-cell column-header" scope="col" role="columnheader" aria-sort$="[[_ariaSort('Overall', sortField, sortAsc)]]"><span class="sortable" on-click="_toggleSort" on-keydown="_checkToggleSort" role="button" tabindex="0">Overall</span></div>
        </div>

        <dom-if if="[[loaded]]">
            <template>
                <dom-repeat items="[[questionStats]]" filter="[[_makeFilter(assignmentId, conceptId)]]" sort="[[_makeSorter(sortField, sortAsc)]]" hidden>
                  <template>
                    <div class="question-row" role="row">
                      <div class="table-cell question-meta question-text" role="rowheader">
                        <span>[[_questionOnly(item.question.text)]]</span>
                        <a class="view-question-link" on-click="_viewQuestion">View</a>
                      </div>
                      <div class="table-cell question-meta scroll">[[item.student]]</div>
                      <dom-repeat items="[[categories]]" as="category" hidden>
                        <template>
                          <div class="table-cell" role="gridcell"><prendus-stacked-bar label="ratings" scores="[[_rawScores(item.rawScores, category)]]"></prendus-stacked-bar></div>
                        </template>
                      </dom-repeat>
                      <div class="table-cell">[[_precision(item.sortStats.overall)]]</div>
                    </div>
                  </template>
                </dom-repeat>
            </template>
        </dom-if>

        <dom-if if="[[!loaded]]">
            <template>
                Loading...
            </template>
        </dom-if>

        <paper-dialog id="question-modal" modal>
          <paper-dialog-scrollable>
            <prendus-flaggable-question question="[[question]]" on-question-flagged="_closeQuestionModal"></prendus-flaggable-question>
          </paper-dialog-scrollable>
          <div class="buttons">
            <paper-button class="prendus-button prendus-button--minor" dialog-dismiss>Close</paper-button>
          </div>
        </paper-dialog>

      </div>
    </div>

  </template>

  <script type="module" src="prendus-course-question-ratings.ts"></script>
</dom-module>
